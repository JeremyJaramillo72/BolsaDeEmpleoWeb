<div class="page-container">
  <div class="page-header">
    <h1>
      <span class="material-icons text-primary" style="vertical-align: middle;">verified_user</span>
      Validación de Empresas
    </h1>
    <p class="page-description">Revise y valide las empresas registradas en el sistema</p>
  </div>

  <div class="alert alert-success" *ngIf="mensajeExito">
    <span class="material-icons">check_circle</span> {{ mensajeExito }}
  </div>

  <div class="alert alert-danger" *ngIf="mensajeError">
    <span class="material-icons">error</span> {{ mensajeError }}
  </div>

  <div class="stats-grid">
    <div class="stat-card pendiente">
      <div class="stat-icon"><span class="material-icons">pending</span></div>
      <div class="stat-content">
        <h4>Pendientes</h4>
        <p class="stat-number">{{ estadisticas.totalPendientes }}</p>
      </div>
    </div>

    <div class="stat-card verificada">
      <div class="stat-icon"><span class="material-icons">verified</span></div>
      <div class="stat-content">
        <h4>Aprobadas</h4>
        <p class="stat-number">{{ estadisticas.totalVerificadas }}</p>
      </div>
    </div>

    <div class="stat-card rechazada">
      <div class="stat-icon"><span class="material-icons">cancel</span></div>
      <div class="stat-content">
        <h4>Rechazadas</h4>
        <p class="stat-number">{{ estadisticas.totalRechazadas }}</p>
      </div>
    </div>
  </div>

  <div class="section-card mt-4">
    <div class="filters-row">
      <div class="filter-tabs">
        <button class="filter-tab" [class.active]="filtroEstado === 'Pendiente'" (click)="cambiarFiltroEstado('Pendiente')">
          Pendientes
        </button>
        <button class="filter-tab" [class.active]="filtroEstado === 'Verificada'" (click)="cambiarFiltroEstado('Verificada')">
          Aprobadas
        </button>
        <button class="filter-tab" [class.active]="filtroEstado === 'Rechazada'" (click)="cambiarFiltroEstado('Rechazada')">
          Rechazadas
        </button>
      </div>

      <div class="search-box">
        <span class="material-icons">search</span>
        <input type="text" [(ngModel)]="filtrosBusqueda" placeholder="Buscar empresa, RUC o correo..." class="search-input">
      </div>
    </div>
  </div>

  <div class="empresas-list mt-3" *ngIf="!cargando">

    <div class="empresa-card" *ngFor="let empresa of empresasPaginadas">
      <div class="empresa-header">
        <div class="empresa-info-principal">
          <h3 class="empresa-nombre">{{ empresa.nombreEmpresa }}</h3>
          <span class="badge" [ngClass]="getEstadoBadgeClass(empresa.estado)">
            {{ empresa.estado }}
          </span>
        </div>
        <div class="empresa-dias" *ngIf="empresa.estado === 'Pendiente'">
          <span class="material-icons" style="font-size: 16px;">schedule</span>
          {{ calcularDiasDesdeRegistro(empresa.fechaRegistro) }} días de espera
        </div>
      </div>

      <div class="empresa-body">
        <div class="empresa-info-grid">
          <div class="info-item">
            <span class="material-icons">badge</span>
            <div class="info-content">
              <span class="info-label">RUC</span>
              <span class="info-value">{{ empresa.ruc }}</span>
            </div>
          </div>

          <div class="info-item">
            <span class="material-icons">location_on</span>
            <div class="info-content">
              <span class="info-label">Ciudad</span>
              <span class="info-value">{{ empresa.nombreCiudad || 'No registrada' }}</span>
            </div>
          </div>

          <div class="info-item">
            <span class="material-icons">email</span>
            <div class="info-content">
              <span class="info-label">Correo</span>
              <span class="info-value">{{ empresa.correo }}</span>
            </div>
          </div>

          <div class="info-item">
            <span class="material-icons">calendar_today</span>
            <div class="info-content">
              <span class="info-label">Registro</span>
              <span class="info-value">{{ empresa.fechaRegistro | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
        </div>

        <div class="mt-2 text-muted" *ngIf="empresa.descripcion">
          <small><em>{{ empresa.descripcion | slice:0:100 }}...</em></small>
        </div>

        <div class="empresa-actions mt-3">
          <button class="btn-action view" (click)="abrirModalDetalle(empresa)">
            <span class="material-icons">visibility</span> Ver Detalle
          </button>

          <button class="btn-action approve" *ngIf="empresa.estado === 'Pendiente'" (click)="abrirModalDetalle(empresa)">
            <span class="material-icons">gavel</span> Validar
          </button>
        </div>
      </div>
    </div>

    <div class="empty-state text-center p-5" *ngIf="empresasPaginadas.length === 0">
      <span class="material-icons" style="font-size: 48px; color: #ccc;">inbox</span>
      <p class="text-muted mt-2">No se encontraron empresas con los filtros actuales.</p>
    </div>
  </div>

  <div class="pagination-container" *ngIf="totalPaginas > 1">
    <button class="btn-page" (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 1">Anterior</button>
    <span class="page-info">Página {{ paginaActual }} de {{ totalPaginas }}</span>
    <button class="btn-page" (click)="cambiarPagina(paginaActual + 1)" [disabled]="paginaActual === totalPaginas">Siguiente</button>
  </div>

  <div class="loading-overlay" *ngIf="cargando">
    <div class="spinner"></div>
    <p>Cargando...</p>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModal && empresaSeleccionada" (click)="cerrarModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">

    <div class="modal-header">
      <h2>{{ empresaSeleccionada.nombreEmpresa }}</h2>
      <button class="btn-close" (click)="cerrarModal()">&times;</button>
    </div>

    <div class="modal-body">
      <div class="detail-section">
        <h4>Información General</h4>
        <p><strong>RUC:</strong> {{ empresaSeleccionada.ruc }}</p>
        <p><strong>Correo:</strong> {{ empresaSeleccionada.correo }}</p>
        <p><strong>Ciudad:</strong> {{ empresaSeleccionada.nombreCiudad }}</p>
        <p><strong>Sitio Web:</strong> <a [href]="'http://' + empresaSeleccionada.sitioWeb" target="_blank">{{ empresaSeleccionada.sitioWeb || 'N/A' }}</a></p>
        <p><strong>Descripción:</strong></p>
        <p class="text-muted">{{ empresaSeleccionada.descripcion }}</p>
      </div>

      <div class="validation-section mt-4" *ngIf="empresaSeleccionada.estado === 'Pendiente'">
        <hr>
        <h4 class="mb-3">Zona de Validación</h4>

        <div class="d-flex gap-2" *ngIf="!accionValidacion">
          <button class="btn btn-success flex-grow-1" (click)="setAccion('Aprobado')">
            <span class="material-icons">check</span> Aprobar
          </button>
          <button class="btn btn-danger flex-grow-1" (click)="setAccion('Rechazado')">
            <span class="material-icons">close</span> Rechazar
          </button>
        </div>

        <div *ngIf="accionValidacion" class="confirm-box p-3 mt-2" [ngClass]="{'bg-light-success': accionValidacion==='Aprobado', 'bg-light-danger': accionValidacion==='Rechazado'}">
          <h5>Confirmar {{ accionValidacion }}</h5>
          <p>¿Está seguro de cambiar el estado de la empresa?</p>

          <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-secondary" (click)="setAccion(null)">Cancelar</button>
            <button class="btn"
                    [ngClass]="accionValidacion==='Aprobado' ? 'btn-success' : 'btn-danger'"
                    (click)="confirmarValidacion()">
              Confirmar
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
